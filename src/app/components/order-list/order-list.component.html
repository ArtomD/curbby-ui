<div class="icon">
    <span [matMenuTriggerFor]="menu" class="material-icons icon" aria-hidden="false" aria-label="Example delete icon"
        matBadge="!" matBadgePosition="after" matBadgeColor="accent">
        message
    </span>
    <mat-menu #menu="matMenu" class="notification-menu">
        <mat-card *ngFor="let conversation of latestConversations" onClick="console.log('here')"
            [ngClass]="conversation.newMessageAvaliable ? 'notification-card new-message' : 'notification-card'">
            <p>{{conversation.phone | phoneFormat}}<b> @ </b>{{conversation?.conversation?.lastInbound |  date:'short'}}
            </p>
            <p><b>Last message: </b>Message goes here</p>
        </mat-card>
    </mat-menu>
</div>
<div class="header-div">
    Order Communications
    <button class="refreshPage" mat-icon-button color="primary" (click)="refresh()"><span class="material-icons">
            refresh
        </span>
    </button>
</div>

<div class="input-div">
    <div id="buttons">
        <button [ngClass]="openMassMessage ? 'opened' : 'closed'" mat-flat-button color="primary"
            (click)="toggleMessageDiv()" class="mass-button"> <span class="material-icons">
                message
            </span> &nbsp;&nbsp; Mass Message</button>
        <button mat-flat-button color="primary" (click)="changeStatus(2)" class="mass-button"><span
                class="material-icons">
                flag
            </span> &nbsp;&nbsp; Completed</button>
        <button mat-flat-button color="primary" (click)="changeStatus(1)" class="mass-button"><span
                class="material-icons">
                flag
            </span> &nbsp;&nbsp; Ready for
            Pickup</button>
        <button mat-flat-button color="primary" (click)="changeStatus(3)" class="mass-button"><span
                class="material-icons">
                flag
            </span> &nbsp;&nbsp; Cancelled</button>
    </div>
    <mat-card id="messages" [hidden]="!openMassMessage">
        <mat-tab-group [hidden]="!openMassMessage" animationDuration="0ms" class="example-headers-align"
            [(selectedIndex)]="messageTemplateSelected">
            <mat-tab label="{{template.name}}" *ngFor="let template of templates;let index = index;">
                <textarea [(ngModel)]="templates[index].tempBody"></textarea>
                <div id="buttonArea">
                    <button class="buttonClose" mat-flat-button color="warn" (click)="toggleMessageDiv()">Close</button>

                    <button class="buttonConfirm" mat-flat-button color="primary" (click)="massMessage()">
                        <span class="material-icons">
                            mail
                        </span>&nbsp;&nbsp; Send</button>
                    <button class="buttonRevert" mat-flat-button color="primary"
                        (click)="cancel(template)">Revert</button>

                </div>

            </mat-tab>
        </mat-tab-group>
    </mat-card>
    <div class="section-header">
        <mat-dialog-content [formGroup]="filterForm" class="search-field order-form">
            <mat-form-field class="dialog-input">
                <mat-label>Type here to start filtering</mat-label>
                <span matPrefix><span class="material-icons ">
                        search
                    </span> &nbsp;</span>
                <input matInput (keyup)="applyFilter($event)" formControlName="label">
                <button mat-button class="close-button" *ngIf="filterForm.value" matSuffix mat-icon-button
                    aria-label="Clear" (click)="clearSearch()">
                    <mat-icon>close</mat-icon>
                </button>
            </mat-form-field>
        </mat-dialog-content>
        <mat-form-field class="dialog-select order-form">
            <mat-label>Status</mat-label>
            <mat-select (selectionChange)="filterManualUpdate()" [(ngModel)]="selectedStatus"
                [formControl]="statusListFC" multiple>
                <mat-select-trigger>
                    <div [hidden]="statusListFC.value.length != statuses.length">
                        All
                    </div>
                    <div [hidden]="statusListFC.value.length != 4">
                        <span *ngFor="let selected of statusListFC.value">
                            {{selected.short}}
                        </span>
                    </div>
                    <div [hidden]="statusListFC.value.length >= 4">
                        <span *ngFor="let selected of statusListFC.value">
                            {{selected.name}}
                        </span>
                    </div>
                </mat-select-trigger>
                <mat-option *ngFor="let status of statuses" [value]="status">{{status.name}}</mat-option>
            </mat-select>

        </mat-form-field>
        <button mat-button class="close-button" [hidden]="statusListFC.value.length == statuses.length" matSuffix
            mat-icon-button aria-label="Clear" (click)="clearStatus()">
            <mat-icon>close</mat-icon>
        </button>
        <mat-form-field class="dialog-select order-form">
            <mat-label>Location</mat-label>
            <mat-select (selectionChange)="filterManualUpdate()" [(ngModel)]="selectedLocationList"
                [formControl]="locationListFC" multiple>
                <mat-select-trigger>
                    <div [hidden]="locationListFC.value.length != locationList.length">
                        All
                    </div>
                    <div [hidden]="locationListFC.value.length >= locationList.length">
                        <span *ngFor="let location of locationListFC.value">
                            {{location}}
                        </span>
                    </div>
                </mat-select-trigger>
                <mat-option *ngFor="let location of locationList" [value]="location">{{location}}</mat-option>
            </mat-select>

        </mat-form-field>
        <button mat-button class="close-button" [hidden]="locationListFC.value.length == locationList.length" matSuffix
            mat-icon-button aria-label="Clear" (click)="clearLocation()">
            <mat-icon>close</mat-icon>
        </button>
        <span class="example-spacer"></span>

        <mat-slide-toggle [(ngModel)]="filterNewMessages" (click)="filterUnread()" class="configToggle order-form">
            Unread only
        </mat-slide-toggle>

    </div>
</div>

<table mat-table matSort (matSortChange)="sortOrderTable($event)" [dataSource]="dataSource"
    *ngIf="server.order_data?.length > 0" class="mat-elevation-z8 example-container curbby-table">

    <!--- Note that these columns can be defined in any order.
          The actual rendered columns are set as a property on the row definition" -->

    <ng-container matColumnDef="selected">
        <th mat-header-cell *matHeaderCellDef mat-header>
            <mat-checkbox [indeterminate]="someOrdersSelected" [(ngModel)]="allOrdersSelected"
                (click)="selectAllToggle()">
            </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let element">
            <mat-checkbox (click)="selectRecord(element)" [(ngModel)]="element.selected"></mat-checkbox>
        </td>
    </ng-container>

    <ng-container matColumnDef="shopifyOrderNumber">
        <th mat-sort-header="orderNumber" mat-header-cell *matHeaderCellDef mat-header> <B>Order #</B> </th>
        <td mat-cell *matCellDef="let element"> {{element.shopifyOrderNumber}} </td>
    </ng-container>

    <ng-container matColumnDef="date">
        <th mat-sort-header="created" mat-header-cell *matHeaderCellDef mat-header> <B>Order Date</B> </th>
        <td mat-cell *matCellDef="let element"> {{element.created | date:'short' }} </td>
    </ng-container>

    <ng-container matColumnDef="status">
        <th mat-sort-header="status" mat-header-cell *matHeaderCellDef mat-header> <B>Status</B> </th>
        <td mat-cell *matCellDef="let element">
            <mat-select (click)="statusClicked(element)" (focusout)="tableIsNotFocused()" [(value)]=" element.status"
                (selectionChange)="statusChanged(element)" class="statusSelect">
                <mat-option *ngFor="let status of statuses" [value]="status.id">{{status.name}}</mat-option>
            </mat-select>
        </td>
    </ng-container>

    <ng-container matColumnDef="phone">
        <th mat-header-cell *matHeaderCellDef mat-header> <B>Phone Number</B> </th>
        <td mat-cell *matCellDef="let element" class="phoneInput">
            <mat-form-field>
                <input (focus)="tableIsFocused()" (focusout)="tableIsNotFocused()" matInput maxlength=" 16"
                    [formControl]="element?.phoneFormControl" [ngModel]="element.phone | phoneFormat"
                    (ngModelChange)="updatePhoneField(element,$event)" (keyup)="validatePhone(element,$event)"
                    (change)="onChange(element)">
                <mat-error
                    [hidden]="!element?.phoneFormControl?.hasError('invalidPhone') || element?.phoneFormControl?.hasError('required')">
                    Please enter a valid phone number
                </mat-error>
                <mat-error [hidden]="!element?.phoneFormControl?.hasError('required')">
                    Phone is <strong>required</strong>
                </mat-error>
            </mat-form-field>
        </td>
    </ng-container>

    <ng-container matColumnDef="lastMessage">
        <th mat-sort-header="lastMessage" mat-header-cell *matHeaderCellDef mat-header> <B>Last Message</B> </th>
        <td mat-cell *matCellDef="let element"> {{element?.conversation?.lastInbound | date:'short' }} </td>
    </ng-container>

    <ng-container matColumnDef="name">
        <th mat-sort-header="customerName" mat-header-cell *matHeaderCellDef mat-header> <B>Customer Name</B> </th>
        <td mat-cell *matCellDef="let element"> {{element.customer?.first_name}} {{element.customer?.last_name}} </td>
    </ng-container>

    <ng-container matColumnDef="location">
        <th mat-sort-header="location" mat-header-cell *matHeaderCellDef mat-header> <B>Pickup Location</B> </th>
        <td mat-cell *matCellDef="let element"> {{element.pickupLocation.code}} </td>
    </ng-container>

    <ng-container matColumnDef="messages">
        <th mat-header-cell *matHeaderCellDef mat-header> </th>
        <td mat-cell *matCellDef="let element">
            <button [ngClass]="element.newMessageAvaliable ? 'newMessage' : 'oldMessage'" mat-flat-button
                color="primary" (click)="openConversation(element)" matBadge="!" matBadgePosition="after"
                matBadgeColor="accent" [matBadgeHidden]="!element.newMessageAvaliable" class="row-button"
                MatBadgeSize='small'>

                <span class="material-icons">
                    message
                </span></button>
        </td>
    </ng-container>

    <ng-container matColumnDef="details">
        <th mat-header-cell *matHeaderCellDef mat-header> </th>
        <td mat-cell *matCellDef="let element">
            <button (click)="openDetails(element)" mat-flat-button color="primary" class="row-button table-button">

                <span class="material-icons">
                    info
                </span></button>
        </td>
    </ng-container>


    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;">
    </tr>
</table>

<mat-paginator [pageSizeOptions]="[10, 25, 100]"></mat-paginator>